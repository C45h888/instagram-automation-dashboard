CONTEXT INJECTION: PHASE 3.6 â€” THE "SDK BRIDGE" IMPLEMENTATION


1. ðŸ“‰ The Architecture Status
Frontend: Successfully uses the Facebook JS SDK to get an accessToken.

Backend: Currently expects an OAuth code (standard server flow) or is disconnected.

The Conflict: The frontend currently tries to bypass the backend and log in directly to Supabase (signInWithIdToken). This fails (Bad ID Token) and causes data corruption (UUID mismatch).

2. ðŸŽ¯ The Goal: "The SDK Bridge"
We will modify the Backend to accept the Access Token that the Frontend SDK already possesses.

The New Flow:

Frontend: User logs in via SDK -> Gets accessToken.

Frontend: Sends accessToken to Backend (POST /api/auth/facebook/token).

Backend:

Verifies token with Meta.

Logs user into Supabase (using Admin privileges).

Crucial: Maps facebook_id (Numeric) to user_id (UUID) in the database.

Returns valid Supabase Session.

Frontend: Saves Session -> Handshakes with Instagram -> Redirects.

3. ðŸ› ï¸ Implementation Plan (Atomic Steps)
Step 1: Backend - Append the Token Handler
File: backend.api/routes/auth.js Action: Add a new route handler POST /facebook/token. Logic:

JavaScript

router.post('/facebook/token', async (req, res) => {
  const { accessToken } = req.body;
  // 1. Verify token with Facebook Graph API (/me)
  // 2. Use supabaseAdmin.auth.signInWithIdToken() (Bypasses "Bad ID Token" error)
  // 3. Upsert into user_profiles (Fixes "Identity Crisis" UUID error)
  // 4. Return { session, user }
});
Step 2: Frontend - Reroute the Traffic
File: src/pages/Login.tsx Action: Modify handleFacebookLoginSuccess. Logic:

REMOVE: The direct call to supabase.auth.signInWithIdToken.

REMOVE: The "Legacy Fallback" block (which saves corrupt data).

ADD: A fetch() call to the new /api/auth/facebook/token endpoint.

ADD: supabase.auth.setSession() using the data returned from the backend.

Step 3: Verify & Clean
Check: Ensure completeHandshake() is called with the provider_token returned by the backend.

Clean: Delete any code in Login.tsx that attempts to save user.id manually to LocalStorage.

Instruction to Agent: Execute this plan immediately. Do not alter the Facebook SDK initialization in the frontend; it is working correctly. Your focus is strictly on piping the token from the SDK to the new Backend Endpoint.