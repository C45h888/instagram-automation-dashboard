CONTEXT INJECTION: PHASE 3.5 â€” THE HANDSHAKE & DUAL-ID CORRECTION
1. ğŸ” Context & Architecture Goal
Project: Instagram Automation Dashboard Current State: We have successfully implemented Phase 3.0 (Backend Auth). The backend.api/routes/auth.js correctly authenticates users, generates a Supabase UUID, and returns a session containing the critical provider_token (Facebook User Access Token).

The Goal: We need to transition from "Authenticated User" to "Connected Business". We must implement a "Zero-Config Handshake" where the system automatically discovers the user's Instagram Business Page, exchanges tokens, and saves credentials without manual user input.

2. ğŸ’¥ The "Disconnect" (Flowchart vs. Reality)
The Intended Flow (The Bridge):

User Logs in â†’ 2. Backend Returns Keys â†’ 3. App Auto-Connects Page â†’ 4. Dashboard Loads Data.

The Current Broken Logic (The Gap):

Step 1 & 2: âœ… WORKING. auth.js returns the provider_token.

Step 3: âŒ BROKEN. The instagram-api.js endpoint /exchange-token is passive. It waits for the Frontend to send a businessAccountId.

The Paradox: The Frontend cannot send the ID because it doesn't know it yet. The Backend is supposed to tell the Frontend, but it won't run the logic unless the Frontend tells it.

Step 4: âŒ FAILS. Frontend tries to query data using the wrong ID or missing credentials.

3. ğŸš¨ Forensic Evidence (Console Log Analysis)
The provided console logs reveal two distinct critical failures:

Failure A: The "Identity Crisis" (Wrong ID Type)
The logs show repeated crashes when the frontend tries to talk to Supabase.

Log: GET .../instagram_business_accounts?...user_id=eq.122098... 400 (Bad Request)

Error: invalid input syntax for type uuid: "122098096448937004"

Diagnosis: The Frontend components (databaseservices.ts, Login.tsx) are mistakenly using the Facebook Numeric ID (122098...) to query columns that require a Supabase UUID.

Root Cause: The authStore or the component logic is grabbing user.facebook_id instead of user.id (UUID) for database operations.

Failure B: The JSON Crash (Missing Handshake)
Log: Login.tsx:530 âŒ Token exchange error: SyntaxError: Failed to execute 'json' on 'Response': Unexpected end of JSON input

Diagnosis: The frontend is hitting an endpoint (likely /exchange-token or a callback) that is crashing or returning empty because the required businessAccountId was undefined during the call.

4. ğŸ› ï¸ Implementation Plan (Atomic Tasks)
You must fix the code in the following order to resolve the Logic Gap and the Identity Crisis.

Task 1: Enable Backend "Auto-Discovery"
File: backend.api/routes/instagram-api.js Current Logic: The /exchange-token route only calls storePageToken if req.body.businessAccountId is present. Required Logic:

Call exchangeForPageToken(userAccessToken) first.

Extract the igBusinessAccountId from the result of that exchange.

Use that discovered ID to call storePageToken, ignoring whether the frontend sent one.

Return the discovered businessAccountId to the frontend.

Task 2: Fix Frontend ID Usage (The UUID Fix)
Files: src/services/databaseservices.ts, src/pages/Login.tsx Action: Audit these files for usage of the user ID. Correction: Ensure that when querying Supabase tables (like user_consents or instagram_business_accounts), you are strictly using the UUID (user.id), NEVER the Facebook ID.

Correction Example: Change user_id: user.facebook_id â†’ user_id: user.id.

Task 3: Implement the "Handshake" in Frontend
File: src/pages/FacebookCallback.tsx Action: Complete the logic to bridge the gap.

Receive session.provider_token from the auth.js response.

Immediately make a POST request to /api/instagram/exchange-token with { userAccessToken: provider_token, userId: user.id }.

Wait for the response (which now contains the businessAccountId).

Update the local state/store with this new ID.

Redirect to Dashboard.



Instagram Automation Dashboard - Complete OAuth to Dashboard Flow
ğŸ“Š Visual Flowchart
graph TB
    Start([User Visits Login Page]) --> CheckConsent{Consent<br/>Checkbox<br/>Checked?}
    CheckConsent -->|No| WaitConsent[Wait for User]
    CheckConsent -->|Yes| InitSDK[Initialize Facebook SDK v23.0]
    
    InitSDK --> LoadSDK[Load Facebook SDK Script]
    LoadSDK --> FBInit[FB.init with App ID]
    FBInit --> VerifySDK[FB.getLoginStatus Verification]
    VerifySDK --> SDKReady{SDK Ready?}
    
    SDKReady -->|No| SDKError[Show Error Message]
    SDKReady -->|Yes| EnableButton[Enable Login Button]
    
    EnableButton --> UserClick[User Clicks 'Continue with Facebook']
    UserClick --> LogConsent[Log Consent to SessionStorage]
    LogConsent --> FetchIP[Fetch IP from ipify.org]
    FetchIP --> RequestScopes[Request Instagram Business Scopes]
    
    RequestScopes --> FBLogin[FB.login with Scopes Array]
    FBLogin --> MetaDialog[Meta OAuth Consent Dialog Opens]
    MetaDialog --> UserAuthorize{User<br/>Authorizes?}
    
    UserAuthorize -->|No| CancelFlow[Cancel Flow - Return to Login]
    UserAuthorize -->|Yes| ReturnToken[Return authResponse]
    
    ReturnToken --> ExtractToken[Extract Short-Lived User Token]
    ExtractToken --> SendToBackend[POST /api/instagram/exchange-token]
    
    SendToBackend --> BackendReceive[Backend Receives Token]
    BackendReceive --> ExchangeLongLived[Exchange for Long-Lived Token]
    
    ExchangeLongLived --> GraphAPI1[POST graph.facebook.com/oauth/access_token]
    GraphAPI1 --> LongLivedToken[Receive 60-Day Token]
    
    LongLivedToken --> FetchUser[GET graph.facebook.com/me]
    FetchUser --> UserData[Receive Facebook User Data]
    
    UserData --> SupabaseSignIn[Supabase Auth signInWithIdToken]
    SupabaseSignIn --> CreateSession[Create Supabase Session]
    CreateSession --> GenerateJWT[Generate JWT Access Token]
    
    GenerateJWT --> UpsertProfile[UPSERT user_profiles Table]
    UpsertProfile --> StoreConsent[INSERT user_consents Table]
    
    StoreConsent --> FetchPages[GET graph.facebook.com/me/accounts]
    FetchPages --> PagesData[Receive Facebook Pages List]
    
    PagesData --> ExtractIGBusiness[Extract instagram_business_account]
    ExtractIGBusiness --> HasIGAccount{Instagram<br/>Business<br/>Account<br/>Connected?}
    
    HasIGAccount -->|No| IGError[Return Error: Connect IG Business Account]
    HasIGAccount -->|Yes| ExtractPageToken[Extract Page Access Token]
    
    ExtractPageToken --> EncryptToken[Encrypt Token via Supabase RPC]
    EncryptToken --> StoreIGAccount[UPSERT instagram_business_accounts]
    StoreIGAccount --> StoreCredentials[UPSERT instagram_credentials]
    
    StoreCredentials --> ReturnSuccess[Return Success Response to Frontend]
    
    ReturnSuccess --> FrontendReceive[Frontend Receives Response]
    FrontendReceive --> SetSession[Set Supabase Session in Browser]
    SetSession --> UpdateAuthStore[Update Zustand authStore]
    
    UpdateAuthStore --> PersistLocal[Persist to localStorage]
    PersistLocal --> RedirectDashboard[Redirect to /dashboard]
    
    RedirectDashboard --> DashboardMount[Dashboard Component Mounts]
    
    DashboardMount --> FetchIGAccount[useInstagramAccount Hook]
    FetchIGAccount --> QueryAccounts[Query instagram_business_accounts Table]
    QueryAccounts --> ExtractIDs[Extract businessAccountId & instagramBusinessId]
    
    ExtractIDs --> ValidateToken[useTokenValidation Hook]
    ValidateToken --> CheckTokenAPI[POST /api/instagram/validate-token]
    CheckTokenAPI --> DecryptCheck[Decrypt Token from DB]
    DecryptCheck --> GraphAPIValidate[Test Token with Graph API]
    
    GraphAPIValidate --> TokenValid{Token<br/>Valid?}
    TokenValid -->|No| ShowBanner[Show TokenExpiredBanner]
    ShowBanner --> ReconnectButton[User Clicks Reconnect]
    ReconnectButton --> Start
    
    TokenValid -->|Yes| FetchProfile[useInstagramProfile Hook]
    FetchProfile --> ProfileAPI[GET /api/instagram/profile/:id]
    ProfileAPI --> DecryptProfile[Backend: Decrypt Page Token]
    DecryptProfile --> GraphProfile[GET graph.facebook.com/:id]
    GraphProfile --> ProfileData[Receive Profile Data]
    
    ProfileData --> FetchDashboard[useDashboardData Hook]
    FetchDashboard --> SyncPosts[POST /api/instagram/sync/posts]
    SyncPosts --> BackgroundSync[Background: Sync Latest Posts to DB]
    
    BackgroundSync --> DashboardAPI[GET /api/instagram/dashboard-stats]
    DashboardAPI --> QueryInsights[Query instagram_media_insights Table]
    QueryInsights --> AggregateMetrics[Aggregate Last 30 Days]
    AggregateMetrics --> DashboardData[Return Metrics, Activities, Media, Chart Data]
    
    DashboardData --> RenderUI[Render Dashboard UI]
    
    RenderUI --> ShowProfile[InstagramProfileCard]
    RenderUI --> ShowMetrics[AnimatedMetricsGrid]
    RenderUI --> ShowActivities[ActivityFeed]
    RenderUI --> ShowChart[PerformanceChart]
    RenderUI --> ShowMedia[RecentMedia]
    
    ShowProfile --> Complete([Dashboard Fully Loaded])
    ShowMetrics --> Complete
    ShowActivities --> Complete
    ShowChart --> Complete
    ShowMedia --> Complete
    
    style Start fill:#e1f5e1
    style Complete fill:#e1f5e1
    style MetaDialog fill:#4267B2,color:#fff
    style GraphAPI1 fill:#4267B2,color:#fff
    style FetchUser fill:#4267B2,color:#fff
    style FetchPages fill:#4267B2,color:#fff
    style GraphProfile fill:#4267B2,color:#fff
    style SupabaseSignIn fill:#3ECF8E,color:#fff
    style CreateSession fill:#3ECF8E,color:#fff
    style UpsertProfile fill:#3ECF8E,color:#fff
    style StoreIGAccount fill:#3ECF8E,color:#fff
    style StoreCredentials fill:#3ECF8E,color:#fff
    style UpdateAuthStore fill:#f0ad4e,color:#fff
    style PersistLocal fill:#f0ad4e,color:#fff



ğŸ“‹ Detailed Step-by-Step Flow Breakdown
PHASE 1: FRONTEND OAUTH INITIATION (src/pages/Login.tsx)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 1: User Lands on Login Page                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Location: /login                                                 â”‚
â”‚ Component: Login.tsx (Lines 13-96)                              â”‚
â”‚                                                                  â”‚
â”‚ âœ“ Displays two OAuth options:                                   â”‚
â”‚   - Continue with Facebook (Primary)                            â”‚
â”‚   - Continue with Instagram (Uses Facebook OAuth)               â”‚
â”‚                                                                  â”‚
â”‚ âœ“ Requires GDPR/CCPA consent checkbox                          â”‚
â”‚ âœ“ Initializes Facebook SDK via useFacebookSDK hook             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 2: Facebook SDK Initialization                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Hook: useFacebookSDK.ts (Lines 23-129)                          â”‚
â”‚                                                                  â”‚
â”‚ Process:                                                         â”‚
â”‚ 1. Load Facebook SDK script dynamically                         â”‚
â”‚    â†’ src="https://connect.facebook.net/en_US/sdk.js"           â”‚
â”‚                                                                  â”‚
â”‚ 2. Call FB.init() with configuration:                           â”‚
â”‚    {                                                             â”‚
â”‚      appId: VITE_META_APP_ID,        // From .env               â”‚
â”‚      version: 'v23.0',               // Latest Meta API         â”‚
â”‚      cookie: true,                   // Enable session cookies  â”‚
â”‚      xfbml: true                     // Parse social plugins    â”‚
â”‚    }                                                             â”‚
â”‚                                                                  â”‚
â”‚ 3. Verify initialization:                                       â”‚
â”‚    â†’ FB.getLoginStatus() to confirm SDK ready                  â”‚
â”‚                                                                  â”‚
â”‚ 4. Set sdkReady = true                                          â”‚
â”‚    â†’ Enables login button                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 3: User Consent & Permission Request                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ User Action: Checks consent checkbox, clicks "Continue"         â”‚
â”‚                                                                  â”‚
â”‚ 1. logConsent() function executes:                              â”‚
â”‚    â†’ Fetch IP: GET https://api.ipify.org?format=json           â”‚
â”‚    â†’ Store in sessionStorage:                                   â”‚
â”‚      {                                                           â”‚
â”‚        consent_type: 'facebook_oauth',                          â”‚
â”‚        ip_address: '203.0.113.42',                              â”‚
â”‚        user_agent: 'Mozilla/5.0...',                            â”‚
â”‚        consented_at: '2025-12-25T10:30:00Z',                   â”‚
â”‚        privacy_policy_version: '1.0',                           â”‚
â”‚        terms_version: '1.0'                                      â”‚
â”‚      }                                                           â”‚
â”‚                                                                  â”‚
â”‚ 2. Request Instagram Business Scopes:                           â”‚
â”‚    [                                                             â”‚
â”‚      'instagram_basic',              // Profile info            â”‚
â”‚      'instagram_manage_insights',    // Analytics data          â”‚
â”‚      'instagram_manage_messages',    // DM inbox access         â”‚
â”‚      'instagram_content_publish',    // Post content            â”‚
â”‚      'instagram_manage_comments',    // Comment moderation      â”‚
â”‚      'pages_show_list',              // List pages              â”‚
â”‚      'pages_read_engagement',        // Engagement metrics      â”‚
â”‚      'public_profile'                // Basic FB profile        â”‚
â”‚    ]                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 4: Meta OAuth Dialog                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Function: window.FB.login(callback, {scope: scopes.join(',')})  â”‚
â”‚                                                                  â”‚
â”‚ Meta's OAuth Flow:                                               â”‚
â”‚ 1. Opens popup window (or redirect)                             â”‚
â”‚ 2. Shows Facebook login if not logged in                        â”‚
â”‚ 3. Displays permission consent screen                           â”‚
â”‚ 4. User reviews requested permissions                           â”‚
â”‚ 5. User clicks "Continue" or "Cancel"                           â”‚
â”‚                                                                  â”‚
â”‚ Response on Success:                                             â”‚
â”‚ {                                                                â”‚
â”‚   status: 'connected',                                           â”‚
â”‚   authResponse: {                                                â”‚
â”‚     accessToken: 'EAAYqK...',      // Short-lived (1 hour)      â”‚
â”‚     userID: '122098096448937004',   // Facebook User ID         â”‚
â”‚     expiresIn: 3600,                // Seconds                   â”‚
â”‚     signedRequest: '...',                                        â”‚
â”‚     graphDomain: 'facebook',                                     â”‚
â”‚     grantedScopes: 'instagram_basic,instagram_manage_insights...'â”‚
â”‚   }                                                              â”‚
â”‚ }                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜



PHASE 2: BACKEND TOKEN EXCHANGE (backend.api/routes/auth.js)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 5: Frontend Sends Token to Backend                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Request: POST /api/instagram/exchange-token                     â”‚
â”‚                                                                  â”‚
â”‚ Body:                                                            â”‚
â”‚ {                                                                â”‚
â”‚   userAccessToken: 'EAAYqK...',    // Short-lived token         â”‚
â”‚   userId: '122098096448937004',     // Facebook User ID         â”‚
â”‚   businessAccountId: 'temp_122098096448937004'                  â”‚
â”‚ }                                                                â”‚
â”‚                                                                  â”‚
â”‚ Headers:                                                         â”‚
â”‚ {                                                                â”‚
â”‚   'Content-Type': 'application/json'                            â”‚
â”‚ }                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 6: Exchange for Long-Lived Token                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ File: backend.api/routes/auth.js (Lines 40-62)                  â”‚
â”‚                                                                  â”‚
â”‚ Meta Graph API Call:                                             â”‚
â”‚ POST https://graph.facebook.com/v23.0/oauth/access_token        â”‚
â”‚                                                                  â”‚
â”‚ Parameters:                                                      â”‚
â”‚ {                                                                â”‚
â”‚   grant_type: 'fb_exchange_token',                              â”‚
â”‚   client_id: process.env.META_APP_ID,                           â”‚
â”‚   client_secret: process.env.META_APP_SECRET,                   â”‚
â”‚   fb_exchange_token: userAccessToken                            â”‚
â”‚ }                                                                â”‚
â”‚                                                                  â”‚
â”‚ Response:                                                        â”‚
â”‚ {                                                                â”‚
â”‚   access_token: 'EAAYqK...',       // Long-lived (60 days)      â”‚
â”‚   token_type: 'bearer',                                          â”‚
â”‚   expires_in: 5183999              // ~60 days in seconds       â”‚
â”‚ }                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 7: Fetch Facebook User Profile                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ File: backend.api/routes/auth.js (Lines 69-86)                  â”‚
â”‚                                                                  â”‚
â”‚ Meta Graph API Call:                                             â”‚
â”‚ GET https://graph.facebook.com/v23.0/me                          â”‚
â”‚   ?fields=id,name,email,picture                                 â”‚
â”‚   &access_token={longLivedToken}                                â”‚
â”‚                                                                  â”‚
â”‚ Response:                                                        â”‚
â”‚ {                                                                â”‚
â”‚   id: '122098096448937004',         // Facebook ID (TEXT)       â”‚
â”‚   name: 'John Doe',                                              â”‚
â”‚   email: 'john@example.com',                                     â”‚
â”‚   picture: {                                                     â”‚
â”‚     data: {                                                      â”‚
â”‚       url: 'https://platform-lookaside.fbsbx.com/...'          â”‚
â”‚     }                                                            â”‚
â”‚   }                                                              â”‚
â”‚ }                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 8: Create Supabase Auth Session                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ File: backend.api/routes/auth.js (Lines 92-115)                 â”‚
â”‚                                                                  â”‚
â”‚ Supabase Admin Auth Call:                                       â”‚
â”‚ supabaseAdmin.auth.signInWithIdToken({                          â”‚
â”‚   provider: 'facebook',                                          â”‚
â”‚   token: longLivedToken,                                         â”‚
â”‚   options: {                                                     â”‚
â”‚     data: {                                                      â”‚
â”‚       facebook_id: '122098096448937004',                         â”‚
â”‚       full_name: 'John Doe',                                     â”‚
â”‚       avatar_url: 'https://...'                                  â”‚
â”‚     }                                                            â”‚
â”‚   }                                                              â”‚
â”‚ })                                                               â”‚
â”‚                                                                  â”‚
â”‚ Creates/Returns:                                                 â”‚
â”‚ {                                                                â”‚
â”‚   user: {                                                        â”‚
â”‚     id: 'a1b2c3d4-e5f6-47a8-9b0c-1d2e3f4a5b6c',  // UUID        â”‚
â”‚     app_metadata: {},                                            â”‚
â”‚     user_metadata: {                                             â”‚
â”‚       facebook_id: '122098096448937004',                         â”‚
â”‚       full_name: 'John Doe',                                     â”‚
â”‚       avatar_url: '...'                                          â”‚
â”‚     },                                                           â”‚
â”‚     created_at: '2025-12-25T10:30:00Z'                          â”‚
â”‚   },                                                             â”‚
â”‚   session: {                                                     â”‚
â”‚     access_token: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...',   â”‚
â”‚     refresh_token: 'v1.MjAyNS0xMi0yNVQxMDozMD...',             â”‚
â”‚     expires_in: 3600,                    // 1 hour              â”‚
â”‚     expires_at: 1703510400,                                      â”‚
â”‚     token_type: 'Bearer',                                        â”‚
â”‚     user: { /* same as above */ }                                â”‚
â”‚   }                                                              â”‚
â”‚ }                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 9: Store User Profile in Database                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Table: user_profiles                                             â”‚
â”‚ File: backend.api/routes/auth.js (Lines 121-148)                â”‚
â”‚                                                                  â”‚
â”‚ SQL Operation: UPSERT                                            â”‚
â”‚ INSERT INTO user_profiles (                                     â”‚
â”‚   user_id,                          -- UUID (PRIMARY KEY)        â”‚
â”‚   facebook_id,                      -- TEXT (UNIQUE)             â”‚
â”‚   email,                                                         â”‚
â”‚   full_name,                                                     â”‚
â”‚   avatar_url,                                                    â”‚
â”‚   instagram_connected,              -- false initially           â”‚
â”‚   user_role,                        -- 'user' (default)          â”‚
â”‚   last_active_at,                                                â”‚
â”‚   updated_at                                                     â”‚
â”‚ ) VALUES (                                                       â”‚
â”‚   'a1b2c3d4-e5f6-47a8-9b0c-1d2e3f4a5b6c',                       â”‚
â”‚   '122098096448937004',                                          â”‚
â”‚   'john@example.com',                                            â”‚
â”‚   'John Doe',                                                    â”‚
â”‚   'https://...',                                                 â”‚
â”‚   false,                                                         â”‚
â”‚   'user',                                                        â”‚
â”‚   NOW(),                                                         â”‚
â”‚   NOW()                                                          â”‚
â”‚ )                                                                â”‚
â”‚ ON CONFLICT (user_id) DO UPDATE SET                             â”‚
â”‚   email = EXCLUDED.email,                                        â”‚
â”‚   full_name = EXCLUDED.full_name,                                â”‚
â”‚   avatar_url = EXCLUDED.avatar_url,                              â”‚
â”‚   last_active_at = NOW(),                                        â”‚
â”‚   updated_at = NOW()                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 10: Log User Consent                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Table: user_consents                                             â”‚
â”‚ File: backend.api/routes/auth.js (Lines 154-171)                â”‚
â”‚                                                                  â”‚
â”‚ SQL Operation: INSERT                                            â”‚
â”‚ INSERT INTO user_consents (                                     â”‚
â”‚   user_id,                                                       â”‚
â”‚   consent_type,                                                  â”‚
â”‚   consent_given,                                                 â”‚
â”‚   consent_text,                                                  â”‚
â”‚   ip_address,                                                    â”‚
â”‚   user_agent,                                                    â”‚
â”‚   consented_at                                                   â”‚
â”‚ ) VALUES (                                                       â”‚
â”‚   'a1b2c3d4-e5f6-47a8-9b0c-1d2e3f4a5b6c',                       â”‚
â”‚   'facebook_oauth',                                              â”‚
â”‚   true,                                                          â”‚
â”‚   'User granted Facebook OAuth permissions',                    â”‚
â”‚   '203.0.113.42',                   -- From request IP           â”‚
â”‚   'Mozilla/5.0...',                 -- From headers              â”‚
â”‚   '2025-12-25T10:30:00Z'                                        â”‚
â”‚ )                                                                â”‚
â”‚                                                                  â”‚
â”‚ Purpose: GDPR/CCPA compliance audit trail                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜



PHASE 3: INSTAGRAM ACCOUNT LINKAGE (backend.api/services/instagram-tokens.js)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 11: Fetch User's Facebook Pages                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ File: backend.api/services/instagram-tokens.js (Lines 49-58)    â”‚
â”‚                                                                  â”‚
â”‚ Meta Graph API Call:                                             â”‚
â”‚ GET https://graph.facebook.com/v23.0/me/accounts                 â”‚
â”‚   ?fields=instagram_business_account                            â”‚
â”‚   &access_token={longLivedUserToken}                            â”‚
â”‚                                                                  â”‚
â”‚ Response:                                                        â”‚
â”‚ {                                                                â”‚
â”‚   data: [                                                        â”‚
â”‚     {                                                            â”‚
â”‚       id: '108491407294665',      // Facebook Page ID           â”‚
â”‚       name: 'My Business Page',                                  â”‚
â”‚       access_token: 'EAAYqK...',  // PAGE TOKEN (60 days)       â”‚
â”‚       instagram_business_account: {                              â”‚
â”‚         id: '17841401234567890'   // Instagram Business ID      â”‚
â”‚       }                                                          â”‚
â”‚     }                                                            â”‚
â”‚   ]                                                              â”‚
â”‚ }                                                                â”‚
â”‚                                                                  â”‚
â”‚ ğŸ”‘ KEY: Page access token is CRITICAL - used for all API calls  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 12: Validate Instagram Business Account                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ File: backend.api/services/instagram-tokens.js (Lines 91-103)   â”‚
â”‚                                                                  â”‚
â”‚ Validation Checks:                                               â”‚
â”‚ âœ“ Instagram business account exists                             â”‚
â”‚ âœ“ Account is type "BUSINESS" (not personal)                     â”‚
â”‚ âœ“ Page has permissions for Instagram                            â”‚
â”‚                                                                  â”‚
â”‚ Error Scenarios:                                                 â”‚
â”‚ âŒ No Instagram account linked â†’ Return error message           â”‚
â”‚ âŒ Personal Instagram (not business) â†’ Guide to convert         â”‚
â”‚ âŒ Permissions missing â†’ Request re-auth                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 13: Encrypt & Store Page Token                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ File: backend.api/services/instagram-tokens.js (Lines 311-382)  â”‚
â”‚                                                                  â”‚
â”‚ 1. Encrypt Page Access Token:                                   â”‚
â”‚    const { data: encrypted } = await supabase.rpc(              â”‚
â”‚      'encrypt_instagram_token',                                  â”‚
â”‚      { token: pageAccessToken }                                  â”‚
â”‚    );                                                            â”‚
â”‚    // Uses Supabase's built-in encryption                       â”‚
â”‚                                                                  â”‚
â”‚ 2. Store Instagram Business Account:                            â”‚
â”‚    Table: instagram_business_accounts                           â”‚
â”‚    UPSERT (                                                      â”‚
â”‚      id,                            -- UUID (generated)          â”‚
â”‚      user_id,                       -- FK to auth.users          â”‚
â”‚      facebook_id,                   -- '122098096448937004'      â”‚
â”‚      page_id,                       -- '108491407294665'         â”‚
â”‚      page_name,                     -- 'My Business Page'        â”‚
â”‚      instagram_business_id,         -- '17841401234567890'       â”‚
â”‚      instagram_username,            -- '@mybusiness'             â”‚
â”‚      is_primary,                    -- true                      â”‚
â”‚      is_active,                     -- true                      â”‚
â”‚      connected_at,                  -- NOW()                     â”‚
â”‚      updated_at                     -- NOW()                     â”‚
â”‚    )                                                             â”‚
â”‚                                                                  â”‚
â”‚ 3. Store Encrypted Credentials:                                 â”‚
â”‚    Table: instagram_credentials                                 â”‚
â”‚    UPSERT (                                                      â”‚
â”‚      user_id,                       -- UUID                      â”‚
â”‚      business_account_id,           -- FK to IG accounts         â”‚
â”‚      access_token_encrypted,        -- Encrypted page token     â”‚
â”‚      token_type,                    -- 'page'                    â”‚
â”‚      scope,                         -- Array of permissions      â”‚
â”‚      issued_at,                     -- NOW()                     â”‚
â”‚      expires_at,                    -- NOW() + 60 days           â”‚
â”‚      is_active                      -- true                      â”‚
â”‚    )                                                             â”‚
â”‚    ON CONFLICT (user_id, business_account_id, token_type)       â”‚
â”‚    DO UPDATE                                                     â”‚
â”‚                                                                  â”‚
â”‚ ğŸ”’ Security: Token never stored in plaintext                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 14: Return Success to Frontend                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ File: backend.api/routes/auth.js (Lines 193-211)                â”‚
â”‚                                                                  â”‚
â”‚ Response: 200 OK                                                 â”‚
â”‚ {                                                                â”‚
â”‚   success: true,                                                 â”‚
â”‚   message: 'Facebook OAuth successful',                         â”‚
â”‚   user: {                                                        â”‚
â”‚     id: 'a1b2c3d4-e5f6-47a8-9b0c-1d2e3f4a5b6c',                â”‚
â”‚     facebook_id: '122098096448937004',                           â”‚
â”‚     email: 'john@example.com',                                   â”‚
â”‚     name: 'John Doe',                                            â”‚
â”‚     avatar_url: 'https://...'                                    â”‚
â”‚   },                                                             â”‚
â”‚   session: {                                                     â”‚
â”‚     access_token: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...',   â”‚
â”‚     refresh_token: 'v1.MjAyNS0xMi0yNVQxMDozMD...',             â”‚
â”‚     expires_in: 3600,                                            â”‚
â”‚     expires_at: 1703510400,                                      â”‚
â”‚     token_type: 'Bearer',                                        â”‚
â”‚     provider_token: 'EAAYqK...'    // Facebook long-lived token â”‚
â”‚   }                                                              â”‚
â”‚ }                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜



PHASE 4: FRONTEND SESSION SETUP (src/pages/AuthCallback.tsx & src/stores/authStore.ts)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 15: Set Supabase Session in Browser                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ File: src/pages/AuthCallback.tsx (Lines 141-148)                â”‚
â”‚                                                                  â”‚
â”‚ Supabase Client Call:                                            â”‚
â”‚ await supabase.auth.setSession({                                â”‚
â”‚   access_token: response.session.access_token,                  â”‚
â”‚   refresh_token: response.session.refresh_token                 â”‚
â”‚ });                                                              â”‚
â”‚                                                                  â”‚
â”‚ Effects:                                                         â”‚
â”‚ âœ“ Stores session in browser (localStorage/sessionStorage)       â”‚
â”‚ âœ“ Sets Authorization header for future requests                 â”‚
â”‚ âœ“ Enables RLS policies (auth.uid() = user UUID)                â”‚
â”‚ âœ“ Triggers onAuthStateChange listener                           â”‚
â”‚ âœ“ Auto-refresh token before expiration                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 16: Update Zustand Auth Store                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ File: src/stores/authStore.ts (Lines 549-620)                   â”‚
â”‚                                                                  â”‚
â”‚ Function: checkSession()                                         â”‚
â”‚                                                                  â”‚
â”‚ Process:                                                         â”‚
â”‚ 1. Get current Supabase session:                                â”‚
â”‚    const { data: { session } } = await supabase.auth.getSession()â”‚
â”‚                                                                  â”‚
â”‚ 2. Fetch user_profiles table:                                   â”‚
â”‚    SELECT * FROM user_profiles WHERE user_id = session.user.id  â”‚
â”‚                                                                  â”‚
â”‚ 3. Check admin status:                                           â”‚
â”‚    SELECT * FROM admin_users WHERE user_id = session.user.id    â”‚
â”‚                                                                  â”‚
â”‚ 4. Map to User object:                                           â”‚
â”‚    {                                                             â”‚
â”‚      id: 'a1b2c3d4-...',            // UUID                      â”‚
â”‚      email: 'john@example.com',                                  â”‚
â”‚      name: 'John Doe',                                           â”‚
â”‚      username: '@mybusiness',       // From IG account           â”‚
â”‚      avatar: 'https://...',                                      â”‚
â”‚      role: 'user',                                               â”‚
â”‚      permissions: [                                              â”‚
â”‚        'dashboard',                                              â”‚
â”‚        'content',                                                â”‚
â”‚        'engagement',                                             â”‚
â”‚        'analytics',                                              â”‚
â”‚        'settings'                                                â”‚
â”‚      ]                                                           â”‚
â”‚    }                                                             â”‚
â”‚                                                                  â”‚
â”‚ 5. Update Zustand state:                                         â”‚
â”‚    set({                                                         â”‚
â”‚      user: mappedUser,                                           â”‚
â”‚      token: session.access_token,                                â”‚
â”‚      session: session,                                           â”‚
â”‚      isAuthenticated: true,                                      â”‚
â”‚      isAdmin: isAdmin,                                           â”‚
â”‚      permissions: mappedUser.permissions,                        â”‚
â”‚      isLoading: false,                                           â”‚
â”‚      error: null                                                 â”‚
â”‚    })                                                            â”‚
â”‚                                                                  â”‚
â”‚ 6. Persist to localStorage:                                      â”‚
â”‚    localStorage.setItem('auth-storage', JSON.stringify({        â”‚
â”‚      state: {                                                    â”‚
â”‚        user, token, isAuthenticated, isAdmin, permissions        â”‚
â”‚      }                                                           â”‚
â”‚    }))                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 17: Redirect to Dashboard                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ File: src/pages/AuthCallback.tsx (Lines 157-161)                â”‚
â”‚                                                                  â”‚
â”‚ Navigation:                                                      â”‚
â”‚ navigate('/dashboard', { replace: true })                       â”‚
â”‚                                                                  â”‚
â”‚ React Router redirects to:                                       â”‚
â”‚ â†’ http://localhost:5173/dashboard                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜



PHASE 5: DASHBOARD DATA LOADING (src/pages/Dashboard.tsx)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 18: Dashboard Component Mounts                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ File: src/pages/Dashboard.tsx (Lines 105-261)                   â”‚
â”‚                                                                  â”‚
â”‚ Parallel Hook Execution:                                         â”‚
â”‚ â”œâ”€ useInstagramAccount()          // Get account IDs            â”‚
â”‚ â”œâ”€ useTokenValidation()           // Validate token             â”‚
â”‚ â”œâ”€ useInstagramProfile()          // Fetch profile              â”‚
â”‚ â”œâ”€ useDashboardData()             // Fetch metrics              â”‚
â”‚ â””â”€ useRealtimeUpdates()           // WebSocket connection       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 19: Retrieve Instagram Account IDs                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Hook: useInstagramAccount                                        â”‚
â”‚ File: src/hooks/useInstagramAccount.ts                           â”‚
â”‚                                                                  â”‚
â”‚ Process:                                                         â”‚
â”‚ 1. Get user UUID from authStore:                                â”‚
â”‚    const userId = useAuthStore(state => state.user?.id)         â”‚
â”‚                                                                  â”‚
â”‚ 2. Query Supabase:                                               â”‚
â”‚    SELECT * FROM instagram_business_accounts                    â”‚
â”‚    WHERE user_id = '{userId}' AND is_active = true              â”‚
â”‚    ORDER BY is_primary DESC, connected_at DESC                  â”‚
â”‚    LIMIT 1                                                       â”‚
â”‚                                                                  â”‚
â”‚ 3. Extract IDs:                                                  â”‚
â”‚    {                                                             â”‚
â”‚      businessAccountId: 'b1c2d3e4-f5a6-47b8-9c0d-2e3f4a5b6c7d', â”‚
â”‚      instagramBusinessId: '17841401234567890',                   â”‚
â”‚      instagramUsername: '@mybusiness',                           â”‚
â”‚      followers: 1234,                                            â”‚
â”‚      isConnected: true                                           â”‚
â”‚    }                                                             â”‚
â”‚                                                                  â”‚
â”‚ ğŸ”‘ These IDs are used in ALL subsequent API calls               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 20: Validate Instagram Token                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Hook: useTokenValidation                                         â”‚
â”‚ File: src/hooks/useTokenValidation.ts                            â”‚
â”‚                                                                  â”‚
â”‚ Request:                                                         â”‚
â”‚ POST /api/instagram/validate-token                              â”‚
â”‚ {                                                                â”‚
â”‚   userId: 'a1b2c3d4-...',                                       â”‚
â”‚   businessAccountId: 'b1c2d3e4-...'                             â”‚
â”‚ }                                                                â”‚
â”‚                                                                  â”‚
â”‚ Backend Process:                                                 â”‚
â”‚ 1. Retrieve encrypted token from instagram_credentials          â”‚
â”‚ 2. Decrypt using Supabase RPC                                   â”‚
â”‚ 3. Check expiration: expires_at > NOW()                         â”‚
â”‚ 4. Test with Graph API:                                          â”‚
â”‚    GET https://graph.facebook.com/v23.0/me                       â”‚
â”‚      ?access_token={pageToken}                                  â”‚
â”‚                                                                  â”‚
â”‚ Response Scenarios:                                              â”‚
â”‚                                                                  â”‚
â”‚ âœ… Valid Token:                                                  â”‚
â”‚ {                                                                â”‚
â”‚   status: 'active',                                              â”‚
â”‚   message: 'Token is valid',                                     â”‚
â”‚   expires_at: '2026-02-23T10:30:00Z'                            â”‚
â”‚ }                                                                â”‚
â”‚                                                                  â”‚
â”‚ âŒ Expired Token:                                                â”‚
â”‚ {                                                                â”‚
â”‚   status: 'expired',                                             â”‚
â”‚   error: 'Token has expired',                                    â”‚
â”‚   details: {                                                     â”‚
â”‚     error_code: 190,              // Meta error code             â”‚
â”‚     error_subcode: 463,           // Token expired               â”‚
â”‚     reason: 'Access token expired'                               â”‚
â”‚   }                                                              â”‚
â”‚ }                                                                â”‚
â”‚                                                                  â”‚
â”‚ Frontend Action:                                                 â”‚
â”‚ if (status === 'expired') {                                      â”‚
â”‚   â†’ Show TokenExpiredBanner with "Reconnect" button             â”‚
â”‚   â†’ Clicking redirects to OAuth flow (back to STEP 1)           â”‚
â”‚ }                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 21: Fetch Instagram Profile Data                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Hook: useInstagramProfile                                        â”‚
â”‚ File: src/hooks/useInstagramProfile.ts                           â”‚
â”‚                                                                  â”‚
â”‚ Request:                                                         â”‚
â”‚ GET /api/instagram/profile/{instagramBusinessId}                â”‚
â”‚   ?userId={userId-UUID}                                         â”‚
â”‚   &businessAccountId={businessAccountId-UUID}                   â”‚
â”‚                                                                  â”‚
â”‚ Backend Process:                                                 â”‚
â”‚ 1. Retrieve & decrypt page token                                â”‚
â”‚ 2. Call Meta Graph API:                                          â”‚
â”‚    GET https://graph.facebook.com/v23.0/17841401234567890        â”‚
â”‚      ?fields=username,name,biography,followers_count,            â”‚
â”‚               follows_count,media_count,profile_picture_url      â”‚
â”‚      &access_token={pageToken}                                  â”‚
â”‚                                                                  â”‚
â”‚ Meta Response:                                                   â”‚
â”‚ {                                                                â”‚
â”‚   id: '17841401234567890',                                       â”‚
â”‚   username: 'mybusiness',                                        â”‚
â”‚   name: 'My Business Name',                                      â”‚
â”‚   biography: 'Official Instagram for...',                        â”‚
â”‚   followers_count: 1234,                                         â”‚
â”‚   follows_count: 567,                                            â”‚
â”‚   media_count: 89,                                               â”‚
â”‚   profile_picture_url: 'https://scontent.cdninstagram.com/...'  â”‚
â”‚ }                                                                â”‚
â”‚                                                                  â”‚
â”‚ Frontend State Update:                                           â”‚
â”‚ setProfile({                                                     â”‚
â”‚   username: '@mybusiness',                                       â”‚
â”‚   name: 'My Business Name',                                      â”‚
â”‚   bio: 'Official Instagram for...',                              â”‚
â”‚   followers: 1234,                                               â”‚
â”‚   following: 567,                                                â”‚
â”‚   posts: 89,                                                     â”‚
â”‚   avatarUrl: 'https://...'                                       â”‚
â”‚ })                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 22: Fetch Dashboard Metrics                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Hook: useDashboardData                                           â”‚
â”‚ File: src/hooks/useDashboardData.ts                              â”‚
â”‚                                                                  â”‚
â”‚ Two-Part Process:                                                â”‚
â”‚                                                                  â”‚
â”‚ Part A: Trigger Background Sync                                 â”‚
â”‚ POST /api/instagram/sync/posts                                  â”‚
â”‚ {                                                                â”‚
â”‚   userId: 'a1b2c3d4-...',                                       â”‚
â”‚   businessAccountId: 'b1c2d3e4-...'                             â”‚
â”‚ }                                                                â”‚
â”‚                                                                  â”‚
â”‚ Backend (Fire & Forget):                                         â”‚
â”‚ 1. Retrieve page token                                           â”‚
â”‚ 2. Fetch latest media:                                           â”‚
â”‚    GET /v23.0/{igBusinessId}/media                               â”‚
â”‚      ?fields=id,caption,media_type,media_url,timestamp,          â”‚
â”‚               like_count,comments_count,permalink                â”‚
â”‚      &limit=50                                                   â”‚
â”‚                                                                  â”‚
â”‚ 3. For each media item, fetch insights:                          â”‚
â”‚    GET /v23.0/{mediaId}/insights                                 â”‚
â”‚      ?metric=impressions,reach,engagement,saved                  â”‚
â”‚                                                                  â”‚
â”‚ 4. UPSERT to database:                                           â”‚
â”‚    - instagram_media (media metadata)                           â”‚
â”‚    - instagram_media_insights (performance metrics)             â”‚
â”‚                                                                  â”‚
â”‚ Part B: Fetch Aggregated Dashboard Stats                        â”‚
â”‚ GET /api/instagram/dashboard-stats/{businessAccountId}          â”‚
â”‚   ?userId={userId}                                              â”‚
â”‚                                                                  â”‚
â”‚ Backend SQL Queries:                                             â”‚
â”‚                                                                  â”‚
â”‚ Query 1: Metrics (Last 30 Days)                                 â”‚
â”‚ SELECT                                                           â”‚
â”‚   SUM(reach) as total_reach,                                     â”‚
â”‚   SUM(impressions) as total_impressions,                         â”‚
â”‚   SUM(engagement) as total_engagement,                           â”‚
â”‚   AVG(engagement_rate) as avg_engagement_rate                    â”‚
â”‚ FROM instagram_media_insights                                   â”‚
â”‚ WHERE business_account_id = $1                                   â”‚
â”‚   AND date >= NOW() - INTERVAL '30 days'                         â”‚
â”‚                                                                  â”‚
â”‚ Query 2: Recent Activities (Comments/Likes)                     â”‚
â”‚ SELECT type, username, media_id, created_at                      â”‚
â”‚ FROM instagram_activities                                       â”‚
â”‚ WHERE business_account_id = $1                                   â”‚
â”‚ ORDER BY created_at DESC                                         â”‚
â”‚ LIMIT 10                                                         â”‚
â”‚                                                                  â”‚
â”‚ Query 3: Recent Media                                            â”‚
â”‚ SELECT id, media_type, media_url, caption, like_count,           â”‚
â”‚        comments_count, timestamp                                 â”‚
â”‚ FROM instagram_media                                             â”‚
â”‚ WHERE business_account_id = $1                                   â”‚
â”‚ ORDER BY timestamp DESC                                          â”‚
â”‚ LIMIT 6                                                          â”‚
â”‚                                                                  â”‚
â”‚ Query 4: Chart Data (Last 7 Days)                               â”‚
â”‚ SELECT                                                           â”‚
â”‚   DATE(date) as date,                                            â”‚
â”‚   SUM(reach) as reach,                                           â”‚
â”‚   SUM(impressions) as impressions,                               â”‚
â”‚   SUM(engagement) as engagement                                  â”‚
â”‚ FROM instagram_media_insights                                   â”‚
â”‚ WHERE business_account_id = $1                                   â”‚
â”‚   AND date >= NOW() - INTERVAL '7 days'                          â”‚
â”‚ GROUP BY DATE(date)                                              â”‚
â”‚ ORDER BY date ASC                                                â”‚
â”‚                                                                  â”‚
â”‚ Response:                                                        â”‚
â”‚ {                                                                â”‚
â”‚   success: true,                                                 â”‚
â”‚   source: 'database',              // Not real-time Graph API    â”‚
â”‚   data: {                                                        â”‚
â”‚     metrics: [                                                   â”‚
â”‚       { label: 'Reach', value: 12345, trend: '+5.2%' },         â”‚
â”‚       { label: 'Impressions', value: 45678, trend: '+12.1%' },  â”‚
â”‚       { label: 'Engagement', value: 890, trend: '+3.4%' },      â”‚
â”‚       { label: 'Followers', value: 1234, trend: '+2.1%' }       â”‚
â”‚     ],                                                           â”‚
â”‚     activities: [                                                â”‚
â”‚       {                                                          â”‚
â”‚         type: 'like',                                            â”‚
â”‚         username: 'user123',                                     â”‚
â”‚         timestamp: '2025-12-25T09:15:00Z',                      â”‚
â”‚         mediaId: '...'                                           â”‚
â”‚       },                                                         â”‚
â”‚       // ... more activities                                     â”‚
â”‚     ],                                                           â”‚
â”‚     recentMedia: [                                               â”‚
â”‚       {                                                          â”‚
â”‚         id: '...',                                               â”‚
â”‚         type: 'IMAGE',                                           â”‚
â”‚         url: 'https://...',                                      â”‚
â”‚         caption: 'Check out our...',                             â”‚
â”‚         likes: 123,                                              â”‚
â”‚         comments: 45,                                            â”‚
â”‚         timestamp: '2025-12-24T14:30:00Z'                       â”‚
â”‚       },                                                         â”‚
â”‚       // ... 5 more media                                        â”‚
â”‚     ],                                                           â”‚
â”‚     chartData: [                                                 â”‚
â”‚       { date: '2025-12-19', reach: 1000, impressions: 3000 },   â”‚
â”‚       { date: '2025-12-20', reach: 1200, impressions: 3500 },   â”‚
â”‚       { date: '2025-12-21', reach: 1100, impressions: 3200 },   â”‚
â”‚       { date: '2025-12-22', reach: 1400, impressions: 4000 },   â”‚
â”‚       { date: '2025-12-23', reach: 1300, impressions: 3800 },   â”‚
â”‚       { date: '2025-12-24', reach: 1500, impressions: 4200 },   â”‚
â”‚       { date: '2025-12-25', reach: 1600, impressions: 4500 }    â”‚
â”‚     ]                                                            â”‚
â”‚   }                                                              â”‚
â”‚ }                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 23: Render Dashboard UI                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ File: src/pages/Dashboard.tsx (Lines 180-261)                   â”‚
â”‚                                                                  â”‚
â”‚ Component Tree:                                                  â”‚
â”‚                                                                  â”‚
â”‚ <Dashboard>                                                      â”‚
â”‚   <TokenExpiredBanner /> (if token expired)                     â”‚
â”‚   <DashboardHeader>                                              â”‚
â”‚     Welcome back, {user.name}!                                   â”‚
â”‚     Quick stats summary                                          â”‚
â”‚   </DashboardHeader>                                             â”‚
â”‚                                                                  â”‚
â”‚   <InstagramProfileCard>                                         â”‚
â”‚     Avatar: {profile.avatarUrl}                                  â”‚
â”‚     Username: @{profile.username}                                â”‚
â”‚     Followers: {profile.followers.toLocaleString()}              â”‚
â”‚     Posts: {profile.posts}                                       â”‚
â”‚   </InstagramProfileCard>                                        â”‚
â”‚                                                                  â”‚
â”‚   <QuickActions>                                                 â”‚
â”‚     [Create Post] [Schedule Content] [View Analytics]           â”‚
â”‚   </QuickActions>                                                â”‚
â”‚                                                                  â”‚
â”‚   <AnimatedMetricsGrid>                                          â”‚
â”‚     {metrics.map(metric => (                                     â”‚
â”‚       <MetricCard key={metric.label}>                            â”‚
â”‚         <Label>{metric.label}</Label>                            â”‚
â”‚         <Value>{metric.value.toLocaleString()}</Value>           â”‚
â”‚         <Trend color={metric.trend.startsWith('+') ? 'green' : 'red'}>â”‚
â”‚           {metric.trend}                                         â”‚
â”‚         </Trend>                                                 â”‚
â”‚       </MetricCard>                                              â”‚
â”‚     ))}                                                          â”‚
â”‚   </AnimatedMetricsGrid>                                         â”‚
â”‚                                                                  â”‚
â”‚   <Grid columns={2}>                                             â”‚
â”‚     <ActivityFeed activities={activities}>                      â”‚
â”‚       {activities.map(activity => (                             â”‚
â”‚         <ActivityItem>                                           â”‚
â”‚           {activity.username} {activity.type}d your post         â”‚
â”‚           <Time>{formatDistanceToNow(activity.timestamp)}</Time> â”‚
â”‚         </ActivityItem>                                          â”‚
â”‚       ))}                                                        â”‚
â”‚     </ActivityFeed>                                              â”‚
â”‚                                                                  â”‚
â”‚     <PerformanceChart data={chartData}>                         â”‚
â”‚       <LineChart>                                                â”‚
â”‚         <XAxis dataKey="date" />                                 â”‚
â”‚         <YAxis />                                                â”‚
â”‚         <Line dataKey="reach" stroke="#8b5cf6" />               â”‚
â”‚         <Line dataKey="impressions" stroke="#3b82f6" />         â”‚
â”‚       </LineChart>                                               â”‚
â”‚     </PerformanceChart>                                          â”‚
â”‚   </Grid>                                                        â”‚
â”‚                                                                  â”‚
â”‚   <RecentMedia media={recentMedia}>                             â”‚
â”‚     <Grid columns={3}>                                           â”‚
â”‚       {recentMedia.map(item => (                                â”‚
â”‚         <MediaCard key={item.id}>                               â”‚
â”‚           <Image src={item.url} />                              â”‚
â”‚           <Stats>                                                â”‚
â”‚             â¤ï¸ {item.likes} ğŸ’¬ {item.comments}                 â”‚
â”‚           </Stats>                                               â”‚
â”‚         </MediaCard>                                             â”‚
â”‚       ))}                                                        â”‚
â”‚     </Grid>                                                      â”‚
â”‚   </RecentMedia>                                                 â”‚
â”‚ </Dashboard>                                                     â”‚
â”‚                                                                  â”‚
â”‚ âœ¨ All data is REAL from user's Instagram Business Account      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜



ğŸ”‘ Critical Architecture Points
Dual-ID Mapping System
Frontend User ID     = UUID (a1b2c3d4-e5f6-47a8-9b0c-1d2e3f4a5b6c)
  â†“ Stored in: Supabase Auth, user_profiles.user_id
  â†“ Used for: Database queries, RLS policies, auth.uid()

Facebook User ID     = TEXT (122098096448937004)
  â†“ Stored in: user_profiles.facebook_id
  â†“ Used for: OAuth callbacks, Meta API correlation

Instagram Business ID = TEXT (17841401234567890)
  â†“ Stored in: instagram_business_accounts.instagram_business_id
  â†“ Used for: All Meta Graph API calls


Token Hierarchy
1. User Access Token (Short-lived)
   â”œâ”€ Lifespan: 1 hour
   â”œâ”€ Obtained: Facebook OAuth
   â””â”€ Usage: ONE-TIME exchange for long-lived token

2. Long-lived User Token
   â”œâ”€ Lifespan: 60 days
   â”œâ”€ Obtained: Token exchange endpoint
   â””â”€ Usage: Fetch user's Facebook pages

3. Page Access Token (CRITICAL)
   â”œâ”€ Lifespan: 60 days
   â”œâ”€ Obtained: /me/accounts endpoint
   â”œâ”€ Stored: Encrypted in instagram_credentials table
   â””â”€ Usage: ALL Instagram Graph API calls


Data Flow Pattern
Meta Graph API (Real-time source)
  â†“
Backend sync endpoint
  â†“
Supabase PostgreSQL (Cache/History)
  â†“
Frontend hooks
  â†“
React UI components


Error Handling Strategy
Token Expired (Error 190)
  â†“
Show TokenExpiredBanner
  â†“
User clicks "Reconnect"
  â†“
Redirect to OAuth (STEP 1)
  â†“
New token stored
  â†“
Dashboard reload with valid data



ğŸ“Š Database Schema Relationships
auth.users (Supabase Auth)
  â”œâ”€ id: UUID (PRIMARY KEY)
  â””â”€ email, created_at, etc.
       â†“
       â†“ (1:1)
       â†“
user_profiles
  â”œâ”€ user_id: UUID (FK â†’ auth.users.id)
  â”œâ”€ facebook_id: TEXT (UNIQUE)
  â”œâ”€ email, full_name, avatar_url
  â””â”€ instagram_connected: BOOLEAN
       â†“
       â†“ (1:N)
       â†“
instagram_business_accounts
  â”œâ”€ id: UUID (PRIMARY KEY)
  â”œâ”€ user_id: UUID (FK â†’ user_profiles.user_id)
  â”œâ”€ facebook_id: TEXT
  â”œâ”€ page_id: TEXT
  â”œâ”€ instagram_business_id: TEXT (UNIQUE)
  â””â”€ instagram_username: TEXT
       â†“
       â†“ (1:1)
       â†“
instagram_credentials
  â”œâ”€ business_account_id: UUID (FK â†’ instagram_business_accounts.id)
  â”œâ”€ access_token_encrypted: TEXT
  â”œâ”€ expires_at: TIMESTAMP
  â””â”€ is_active: BOOLEAN
       â†“
       â†“ (1:N)
       â†“
instagram_media
  â”œâ”€ business_account_id: UUID (FK)
  â”œâ”€ instagram_media_id: TEXT
  â”œâ”€ media_type, media_url, caption
  â””â”€ like_count, comments_count
       â†“
       â†“ (1:N)
       â†“
instagram_media_insights
  â”œâ”€ media_id: UUID (FK â†’ instagram_media.id)
  â”œâ”€ date: DATE
  â”œâ”€ impressions, reach, engagement
  â””â”€ saved, profile_visits




Console logs after the most recent sprint

ğŸš€ Starting real-time polling every 3000 ms
realtimeService.ts:106 ğŸ‘‚ Subscribed to any events
useTokenValidation.ts:110 [Token Validation] Skipping validation - no user or businessAccountId
authStore.ts:678 ğŸ”„ Auth state changed: INITIAL_SESSION
uromexjprcrjfmhkmgxa.supabase.co/rest/v1/instagram_business_accounts?select=*&user_id=eq.122098096448937004&is_connected=eq.true&order=created_at.desc:1  Failed to load resource: the server responded with a status of 400 ()
databaseservices.ts:123 Get business accounts error: Object
(anonymous) @ databaseservices.ts:123
uromexjprcrjfmhkmgxa.supabase.co/rest/v1/instagram_business_accounts?select=*&user_id=eq.122098096448937004&is_connected=eq.true&order=created_at.desc:1  Failed to load resource: the server responded with a status of 400 ()
databaseservices.ts:123 Get business accounts error: Object
(anonymous) @ databaseservices.ts:123
realtimeService.ts:95 â¹ï¸ Stopped real-time polling
realtimeService.ts:116 ğŸ”‡ Unsubscribed from any events
useFacebookSDK.ts:99 ğŸ“¢ window.FB detected, initializing immediately
useFacebookSDK.ts:34 ğŸ”µ Attempting Facebook SDK initialization...
useFacebookSDK.ts:35    App ID: 1449604936071207
useFacebookSDK.ts:52 ğŸ”„ Calling FB.init() with v23.0...
useFacebookSDK.ts:69 âœ… FB.init() called successfully
useFacebookSDK.ts:70    App ID: 1449604936071207
useFacebookSDK.ts:71    SDK Version: v23.0
useFacebookSDK.ts:75 ğŸ”„ Verifying initialization with getLoginStatus test...
useFacebookSDK.ts:78 âœ… Facebook SDK verified and ready
useFacebookSDK.ts:79    Status: connected
Login.tsx:190 âœ… Consent metadata stored in session
Login.tsx:191    Timestamp: 2025-12-25T07:16:00.553Z
Login.tsx:192    IP Address: 49.36.8.131
Login.tsx:193    Policy Versions: Privacy v2.0, Terms v2.0
Login.tsx:194    â³ Will be persisted to database after authentication
Login.tsx:431 ğŸ”µ Initiating Facebook OAuth via official SDK...
Login.tsx:432    âœ… User consent verified and logged
useFacebookSDK.ts:168 ğŸ”µ facebookLogin called with scopes: (8)Â ['instagram_basic', 'instagram_manage_insights', 'instagram_manage_messages', 'instagram_content_publish', 'instagram_manage_comments', 'pages_show_list', 'pages_read_engagement', 'public_profile']
useFacebookSDK.ts:192 ğŸ”„ Calling FB.login()...
useFacebookSDK.ts:215 âœ… FB.login() called without throwing
sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:94  GET https://www.facebook.com/platform/impression.php/f704e5f620758d0c8/?api_key=1449604936071207&lid=117&payload=%7B%22payload%22%3A%7B%22cbt_delta%22%3A0%2C%22logger_id%22%3A%22fefc3415cfac1ba46%22%2C%22action%22%3A%22client_login_start%22%2C%22client_funnel_version%22%3A1%7D%2C%22source%22%3A%22jssdk%22%7D net::ERR_BLOCKED_BY_ADBLOCKER
s @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:94
e @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:94
c @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:94
s @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:111
c @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:151
transform @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:151
prepareCall @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:151
e @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:152
s @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:112
login @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:153
(anonymous) @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:78
(anonymous) @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:68
(anonymous) @ useFacebookSDK.ts:194
he @ useFacebookSDK.ts:167
(anonymous) @ Login.tsx:458
r @ auth-jHjS7u4J.js:1
Promise.then
u @ auth-jHjS7u4J.js:1
(anonymous) @ auth-jHjS7u4J.js:1
g @ auth-jHjS7u4J.js:1
H @ Login.tsx:395
Zf @ react-dom.production.min.js:54
qf @ react-dom.production.min.js:54
bf @ react-dom.production.min.js:55
Si @ react-dom.production.min.js:105
ia @ react-dom.production.min.js:106
(anonymous) @ react-dom.production.min.js:117
Io @ react-dom.production.min.js:273
Rs @ react-dom.production.min.js:52
Wl @ react-dom.production.min.js:109
so @ react-dom.production.min.js:74
vc @ react-dom.production.min.js:73
sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:94  Uncaught (in promise) TypeError: Failed to fetch
    at s (sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:94:956)
    at e (sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:94:794)
    at Object.c [as log] (sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:94:1678)
    at Object.s [as logEvent] (sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:111:957)
    at c (sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:151:2905)
    at transform (sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:151:4141)
    at Object.prepareCall (sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:151:8019)
    at e (sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:152:1076)
    at Object.s [as login] (sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:112:617)
    at Object.login (sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:153:774)
s @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:94
e @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:94
c @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:94
s @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:111
c @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:151
transform @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:151
prepareCall @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:151
e @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:152
s @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:112
login @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:153
(anonymous) @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:78
(anonymous) @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:68
(anonymous) @ useFacebookSDK.ts:194
he @ useFacebookSDK.ts:167
(anonymous) @ Login.tsx:458
r @ auth-jHjS7u4J.js:1
Promise.then
u @ auth-jHjS7u4J.js:1
(anonymous) @ auth-jHjS7u4J.js:1
g @ auth-jHjS7u4J.js:1
H @ Login.tsx:395
Zf @ react-dom.production.min.js:54
qf @ react-dom.production.min.js:54
bf @ react-dom.production.min.js:55
Si @ react-dom.production.min.js:105
ia @ react-dom.production.min.js:106
(anonymous) @ react-dom.production.min.js:117
Io @ react-dom.production.min.js:273
Rs @ react-dom.production.min.js:52
Wl @ react-dom.production.min.js:109
so @ react-dom.production.min.js:74
vc @ react-dom.production.min.js:73
sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:49 You are overriding current access token, that means some other app is expecting different access token and you will probably break things. Please consider passing access_token directly to API parameters instead of overriding the global settings.
s @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:49
setAccessToken @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:134
(anonymous) @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:191
o @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:61
inform @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:61
(anonymous) @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:66
d @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:112
(anonymous) @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:112
_xdRecv @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:151
(anonymous) @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:151
b @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:148
(anonymous) @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:148
useFacebookSDK.ts:195 ğŸ“¥ FB.login callback received
useFacebookSDK.ts:196    Response status: connected
useFacebookSDK.ts:199 âœ… Facebook login successful
useFacebookSDK.ts:200    Access Token: EAAUmaHNHeCcBQVM8kIN...
useFacebookSDK.ts:201    User ID: 122098096448937004
useFacebookSDK.ts:202    Granted Scopes: read_insights,pages_show_list,instagram_basic,instagram_manage_comments,instagram_manage_insights,instagram_content_publish,instagram_manage_messages,pages_read_engagement
Login.tsx:461 âœ… Facebook OAuth successful!
Login.tsx:462    Access Token received
Login.tsx:463    User ID: 122098096448937004
sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:94  GET https://www.facebook.com/platform/impression.php/f668e4a91fe4d7708/?api_key=1449604936071207&lid=117&payload=%7B%22payload%22%3A%7B%22cbt_delta%22%3A5687%2C%22logger_id%22%3A%22fefc3415cfac1ba46%22%2C%22action%22%3A%22client_login_end%22%2C%22client_funnel_version%22%3A1%7D%2C%22source%22%3A%22jssdk%22%7D net::ERR_BLOCKED_BY_ADBLOCKER
s @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:94
e @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:94
c @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:94
s @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:111
u @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:111
g @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:112
(anonymous) @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:112
_xdRecv @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:151
(anonymous) @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:151
b @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:148
(anonymous) @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:148
sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:94  Uncaught (in promise) TypeError: Failed to fetch
    at s (sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:94:956)
    at e (sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:94:794)
    at Object.c [as log] (sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:94:1678)
    at s (sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:111:957)
    at Object.u [as logLoginEvent] (sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:111:1158)
    at g (sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:112:5746)
    at sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:112:5558
    at Object._xdRecv (sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:151:14671)
    at sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:151:14084
    at b (sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:148:2269)
s @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:94
e @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:94
c @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:94
s @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:111
u @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:111
g @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:112
(anonymous) @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:112
_xdRecv @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:151
(anonymous) @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:151
b @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:148
(anonymous) @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:148
Login.tsx:530 âŒ Token exchange error: SyntaxError: Failed to execute 'json' on 'Response': Unexpected end of JSON input
    at Login.tsx:497:55
    at Generator.next (<anonymous>)
    at r (auth-jHjS7u4J.js:1:485)
(anonymous) @ Login.tsx:530
l @ auth-jHjS7u4J.js:1
Promise.then
u @ auth-jHjS7u4J.js:1
r @ auth-jHjS7u4J.js:1
Promise.then
u @ auth-jHjS7u4J.js:1
r @ auth-jHjS7u4J.js:1
Promise.then
u @ auth-jHjS7u4J.js:1
r @ auth-jHjS7u4J.js:1
Promise.then
u @ auth-jHjS7u4J.js:1
(anonymous) @ auth-jHjS7u4J.js:1
g @ auth-jHjS7u4J.js:1
H @ Login.tsx:395
Zf @ react-dom.production.min.js:54
qf @ react-dom.production.min.js:54
bf @ react-dom.production.min.js:55
Si @ react-dom.production.min.js:105
ia @ react-dom.production.min.js:106
(anonymous) @ react-dom.production.min.js:117
Io @ react-dom.production.min.js:273
Rs @ react-dom.production.min.js:52
Wl @ react-dom.production.min.js:109
so @ react-dom.production.min.js:74
vc @ react-dom.production.min.js:73
Login.tsx:533 âš ï¸ Using short-lived token as fallback
(anonymous) @ Login.tsx:533
l @ auth-jHjS7u4J.js:1
Promise.then
u @ auth-jHjS7u4J.js:1
r @ auth-jHjS7u4J.js:1
Promise.then
u @ auth-jHjS7u4J.js:1
r @ auth-jHjS7u4J.js:1
Promise.then
u @ auth-jHjS7u4J.js:1
r @ auth-jHjS7u4J.js:1
Promise.then
u @ auth-jHjS7u4J.js:1
(anonymous) @ auth-jHjS7u4J.js:1
g @ auth-jHjS7u4J.js:1
H @ Login.tsx:395
Zf @ react-dom.production.min.js:54
qf @ react-dom.production.min.js:54
bf @ react-dom.production.min.js:55
Si @ react-dom.production.min.js:105
ia @ react-dom.production.min.js:106
(anonymous) @ react-dom.production.min.js:117
Io @ react-dom.production.min.js:273
Rs @ react-dom.production.min.js:52
Wl @ react-dom.production.min.js:109
so @ react-dom.production.min.js:74
vc @ react-dom.production.min.js:73
authStore.ts:274 âœ… Legacy login successful: facebook_user
fetch.js:23  POST https://uromexjprcrjfmhkmgxa.supabase.co/rest/v1/user_consents?columns=%22consent_type%22%2C%22consent_given%22%2C%22ip_address%22%2C%22user_agent%22%2C%22privacy_policy_version%22%2C%22terms_version%22%2C%22consented_at%22%2C%22user_id%22&select=* 400 (Bad Request)
(anonymous) @ fetch.js:23
(anonymous) @ fetch.js:44
a @ fetch.js:4
Promise.then
c @ fetch.js:6
(anonymous) @ fetch.js:7
zs @ fetch.js:3
(anonymous) @ fetch.js:34
then @ PostgrestBuilder.js:66
Login.tsx:282 âŒ Failed to persist consent to database: Error: Database insert failed: invalid input syntax for type uuid: "122098096448937004"
    at Login.tsx:263:15
    at Generator.next (<anonymous>)
    at r (auth-jHjS7u4J.js:1:485)
(anonymous) @ Login.tsx:282
r @ auth-jHjS7u4J.js:1
Promise.then
u @ auth-jHjS7u4J.js:1
(anonymous) @ auth-jHjS7u4J.js:1
g @ auth-jHjS7u4J.js:1
P @ Login.tsx:230
(anonymous) @ Login.tsx:543
l @ auth-jHjS7u4J.js:1
Promise.then
u @ auth-jHjS7u4J.js:1
r @ auth-jHjS7u4J.js:1
Promise.then
u @ auth-jHjS7u4J.js:1
r @ auth-jHjS7u4J.js:1
Promise.then
u @ auth-jHjS7u4J.js:1
r @ auth-jHjS7u4J.js:1
Promise.then
u @ auth-jHjS7u4J.js:1
(anonymous) @ auth-jHjS7u4J.js:1
g @ auth-jHjS7u4J.js:1
H @ Login.tsx:395
Zf @ react-dom.production.min.js:54
qf @ react-dom.production.min.js:54
bf @ react-dom.production.min.js:55
Si @ react-dom.production.min.js:105
ia @ react-dom.production.min.js:106
(anonymous) @ react-dom.production.min.js:117
Io @ react-dom.production.min.js:273
Rs @ react-dom.production.min.js:52
Wl @ react-dom.production.min.js:109
so @ react-dom.production.min.js:74
vc @ react-dom.production.min.js:73
Login.tsx:283 âš ï¸ Consent metadata was captured but database insert failed
(anonymous) @ Login.tsx:283
r @ auth-jHjS7u4J.js:1
Promise.then
u @ auth-jHjS7u4J.js:1
(anonymous) @ auth-jHjS7u4J.js:1
g @ auth-jHjS7u4J.js:1
P @ Login.tsx:230
(anonymous) @ Login.tsx:543
l @ auth-jHjS7u4J.js:1
Promise.then
u @ auth-jHjS7u4J.js:1
r @ auth-jHjS7u4J.js:1
Promise.then
u @ auth-jHjS7u4J.js:1
r @ auth-jHjS7u4J.js:1
Promise.then
u @ auth-jHjS7u4J.js:1
r @ auth-jHjS7u4J.js:1
Promise.then
u @ auth-jHjS7u4J.js:1
(anonymous) @ auth-jHjS7u4J.js:1
g @ auth-jHjS7u4J.js:1
H @ Login.tsx:395
Zf @ react-dom.production.min.js:54
qf @ react-dom.production.min.js:54
bf @ react-dom.production.min.js:55
Si @ react-dom.production.min.js:105
ia @ react-dom.production.min.js:106
(anonymous) @ react-dom.production.min.js:117
Io @ react-dom.production.min.js:273
Rs @ react-dom.production.min.js:52
Wl @ react-dom.production.min.js:109
so @ react-dom.production.min.js:74
vc @ react-dom.production.min.js:73
realtimeService.ts:59 ğŸš€ Starting real-time polling every 3000 ms
realtimeService.ts:106 ğŸ‘‚ Subscribed to any events
useTokenValidation.ts:110 [Token Validation] Skipping validation - no user or businessAccountId
fetch.js:23  GET https://uromexjprcrjfmhkmgxa.supabase.co/rest/v1/instagram_business_accounts?select=*&user_id=eq.122098096448937004&is_connected=eq.true&order=created_at.desc 400 (Bad Request)
(anonymous) @ fetch.js:23
(anonymous) @ fetch.js:44
a @ fetch.js:4
Promise.then
c @ fetch.js:6
(anonymous) @ fetch.js:7
zs @ fetch.js:3
(anonymous) @ fetch.js:34
then @ PostgrestBuilder.js:66
databaseservices.ts:123 Get business accounts error: {code: '22P02', details: null, hint: null, message: 'invalid input syntax for type uuid: "122098096448937004"'}
(anonymous) @ databaseservices.ts:123
i @ components-9P_zoejP.js:1
Promise.then
s @ components-9P_zoejP.js:1
(anonymous) @ components-9P_zoejP.js:1
ue @ components-9P_zoejP.js:1
getBusinessAccounts @ databaseservices.ts:106
(anonymous) @ useInstagramAccount.ts:35
(anonymous) @ components-9P_zoejP.js:1
ue @ components-9P_zoejP.js:1
s @ useInstagramAccount.ts:24
(anonymous) @ useInstagramAccount.ts:55
al @ react-dom.production.min.js:243
Zt @ react-dom.production.min.js:285
(anonymous) @ react-dom.production.min.js:281
E @ scheduler.production.min.js:13
sn @ scheduler.production.min.js:14
fetch.js:23  GET https://uromexjprcrjfmhkmgxa.supabase.co/rest/v1/instagram_business_accounts?select=*&user_id=eq.122098096448937004&is_connected=eq.true&order=created_at.desc 400 (Bad Request)
(anonymous) @ fetch.js:23
(anonymous) @ fetch.js:44
a @ fetch.js:4
Promise.then
c @ fetch.js:6
(anonymous) @ fetch.js:7
zs @ fetch.js:3
(anonymous) @ fetch.js:34
then @ PostgrestBuilder.js:66
databaseservices.ts:123 Get business accounts error: {code: '22P02', details: null, hint: null, message: 'invalid input syntax for type uuid: "122098096448937004"'}
(anonymous) @ databaseservices.ts:123
i @ components-9P_zoejP.js:1
Promise.then
s @ components-9P_zoejP.js:1
(anonymous) @ components-9P_zoejP.js:1
ue @ components-9P_zoejP.js:1
getBusinessAccounts @ databaseservices.ts:106
(anonymous) @ useInstagramAccount.ts:35
(anonymous) @ components-9P_zoejP.js:1
ue @ components-9P_zoejP.js:1
s @ useInstagramAccount.ts:24
(anonymous) @ useInstagramAccount.ts:55
al @ react-dom.production.min.js:243
Zt @ react-dom.production.min.js:285
(anonymous) @ react-dom.production.min.js:281
E @ scheduler.production.min.js:13
sn @ scheduler.production.min.js:14
sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:94  GET https://www.facebook.com/platform/impression.php/f42bb63fc80f2190f/?api_key=1449604936071207&lid=117&payload=%7B%22payload%22%3A%7B%22cbt_delta%22%3A10689%2C%22logger_id%22%3A%22fefc3415cfac1ba46%22%2C%22action%22%3A%22client_login_complete_heartbeat%22%2C%22client_funnel_version%22%3A1%7D%2C%22source%22%3A%22jssdk%22%7D net::ERR_BLOCKED_BY_ADBLOCKER
s @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:94
e @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:94
c @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:94
s @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:111
u @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:111
(anonymous) @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:112
setTimeout
g @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:112
(anonymous) @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:112
_xdRecv @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:151
(anonymous) @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:151
b @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:148
(anonymous) @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:148
sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:94  Uncaught (in promise) TypeError: Failed to fetch
    at s (sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:94:956)
    at e (sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:94:794)
    at Object.c [as log] (sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:94:1678)
    at s (sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:111:957)
    at Object.u [as logLoginEvent] (sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:111:1158)
    at sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:112:5816
s @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:94
e @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:94
c @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:94
s @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:111
u @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:111
(anonymous) @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:112
setTimeout
g @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:112
(anonymous) @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:112
_xdRecv @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:151
(anonymous) @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:151
b @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:148
(anonymous) @ sdk.js?hash=e450c51aaa80f76e9d5418258b94b5d4:148