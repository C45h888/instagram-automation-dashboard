# Supabase Secure Tunnel Configuration
# This file configures Tunnel B for secure database access

tunnel: supabase-secure-tunnel
credentials-file: ~/.cloudflared/supabase-secure-tunnel.json

# Ingress rules define how traffic is routed
ingress:
  # Main rule: Route db-secure subdomain to Supabase
  - hostname: db-secure.888intelligenceautomation.in
    service: ${SUPABASE_URL}
    originRequest:
      # CRITICAL: These headers ensure Supabase recognizes the request
      httpHostHeader: ${SUPABASE_PROJECT_REF}.supabase.co
      originServerName: ${SUPABASE_PROJECT_REF}.supabase.co
      # SSL/TLS configuration
      noTLSVerify: false
      caPool: /etc/ssl/certs/ca-certificates.crt
      # Connection optimization
      connectTimeout: 30s
      tlsTimeout: 10s
      tcpKeepAlive: 30s
      keepAliveConnections: 100
      keepAliveTimeout: 90s
      # HTTP/2 support
      http2Origin: true
  
  # Catch-all rule (required by Cloudflare)
  - service: http_status:404

# Metrics endpoint for monitoring (optional)
metrics: 0.0.0.0:9091

# Logging configuration
loglevel: info
logfile: /var/log/cloudflared-supabase.log

# Grace period for shutdown
grace-period: 30s

# Retry configuration
retries: 5